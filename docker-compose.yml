services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: postgres:16-alpine
    container_name: callcenter-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./services/backend/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - callcenter-network

  # ===========================================
  # Backend API + WebSocket Manager
  # ===========================================
  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    container_name: callcenter-backend
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - TTS_URL=http://tts:8001
      - STT_URL=http://stt:8002
      - LLM_URL=http://llm:8003
      - CALL_CENTER_GREETING=${CALL_CENTER_GREETING}
    ports:
      - "${BACKEND_PORT}:8000"
    volumes:
      - ./shared/audio:/app/audio
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - callcenter-network

  # ===========================================
  # Spanish F5-TTS Service
  # ===========================================
  tts:
    build:
      context: ./services/tts
      dockerfile: Dockerfile
    container_name: callcenter-tts
    restart: unless-stopped
    environment:
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - TTS_MODEL=${TTS_MODEL}
      - DEVICE=${TTS_DEVICE}
    ports:
      - "${TTS_PORT}:8001"
    volumes:
      - ./shared/models:/app/models
      - ./shared/audio:/app/audio
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    networks:
      - callcenter-network

  # ===========================================
  # Whisper STT Service
  # ===========================================
  stt:
    build:
      context: ./services/stt
      dockerfile: Dockerfile
    container_name: callcenter-stt
    restart: unless-stopped
    environment:
      - STT_MODEL=${STT_MODEL}
      - DEVICE=${STT_DEVICE}
      - LANGUAGE=${STT_LANGUAGE}
    ports:
      - "${STT_PORT}:8002"
    volumes:
      - ./shared/models:/app/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    networks:
      - callcenter-network

  # ===========================================
  # LLM Service (LangChain + LM Studio)
  # ===========================================
  llm:
    build:
      context: ./services/llm
      dockerfile: Dockerfile
    container_name: callcenter-llm
    restart: unless-stopped
    environment:
      - LM_STUDIO_URL=${LM_STUDIO_URL}
      - LM_STUDIO_MODEL=${LM_STUDIO_MODEL}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "${LLM_PORT}:8003"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - callcenter-network

  # ===========================================
  # Audio Preprocessing (Noise Suppression + Speaker ID)
  # ===========================================
  audio_preprocess:
    build:
      context: ./services/audio_preprocess
      dockerfile: Dockerfile
    container_name: callcenter-audio-preprocess
    restart: unless-stopped
    environment:
      - DEVICE=${AUDIO_DEVICE:-cuda}
      - SAMPLE_RATE=16000
      - DENOISE_MODEL=deepfilternet
    ports:
      - "${AUDIO_PREPROCESS_PORT:-8004}:8004"
    volumes:
      - ./shared/models:/app/models
      - audio_preprocess_data:/app/data
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    networks:
      - callcenter-network

  # ===========================================
  # MariaDB (Para FreePBX)
  # ===========================================
  mariadb:
    image: mariadb:10.11
    container_name: callcenter-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: asterisk
      MYSQL_USER: ${MYSQL_USER:-asteriskuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-asteriskpass}
    volumes:
      - mariadb_data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - callcenter-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Asterisk PBX
  # ===========================================
  asterisk:
    build:
      context: ./services/asterisk
      dockerfile: Dockerfile
    container_name: callcenter-asterisk
    restart: unless-stopped
    environment:
      - ASTERISK_USER=${ASTERISK_USER}
      - ASTERISK_PASSWORD=${ASTERISK_PASSWORD}
      - ARI_PASSWORD=${ARI_PASSWORD:-ari123}
      - FREEPBX_AMI_PASSWORD=${FREEPBX_AMI_PASSWORD:-freepbx123}
      - BACKEND_AMI_PASSWORD=${BACKEND_AMI_PASSWORD:-backend123}
      - GATEWAY_FXO_IP=${GATEWAY_FXO_IP:-192.168.1.100}
      - GATEWAY_FXO_USER=${GATEWAY_FXO_USER:-gateway}
      - GATEWAY_FXO_PASSWORD=${GATEWAY_FXO_PASSWORD:-gateway123}
    ports:
      - "${ASTERISK_SIP_PORT}:5060/udp"
      - "${ASTERISK_SIP_PORT}:5060/tcp"
      - "${ASTERISK_WS_PORT}:8088"
      - "5038:5038"  # AMI port
      - "10000-10100:10000-10100/udp" # RTP ports
    volumes:
      - ./services/asterisk/config:/etc/asterisk/custom
      - asterisk_logs:/var/log/asterisk
      - asterisk_spool:/var/spool/asterisk
    # Descomenta si usas tarjetas DAHDI:
    # privileged: true
    # devices:
    #   - /dev/dahdi:/dev/dahdi
    networks:
      - callcenter-network
    depends_on:
      mariadb:
        condition: service_healthy

  # ===========================================
  # FreePBX (Interfaz de Gesti√≥n)
  # ===========================================
  freepbx:
    image: tiredofit/freepbx:17-latest
    container_name: callcenter-freepbx
    restart: unless-stopped
    environment:
      # Base de datos
      - DB_EMBEDDED=FALSE
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_NAME=asterisk
      - DB_USER=${MYSQL_USER:-asteriskuser}
      - DB_PASS=${MYSQL_PASSWORD:-asteriskpass}

      # RTP ports
      - RTP_START=10000
      - RTP_FINISH=10100

      # UCP (User Control Panel)
      - ENABLE_UCP=TRUE

      # Asterisk config location
      - ASTERISK_CONFIG_LOCATION=custom

      # Timezone
      - TZ=America/Mexico_City

      # Admin credentials
      - ADMIN_USER=${FREEPBX_ADMIN_USER:-admin}
      - ADMIN_PASS=${FREEPBX_ADMIN_PASSWORD:-admin123}
    ports:
      - "8080:80"   # FreePBX Web UI
      - "8443:443"  # FreePBX HTTPS
    volumes:
      - ./services/asterisk/config:/etc/asterisk/custom
      - freepbx_data:/data
      - freepbx_backup:/var/lib/asterisk/backup
    networks:
      - callcenter-network
    depends_on:
      mariadb:
        condition: service_healthy
      asterisk:
        condition: service_started

  # ===========================================
  # React Dashboard
  # ===========================================
  dashboard:
    build:
      context: ./services/dashboard
      dockerfile: Dockerfile
    container_name: callcenter-dashboard
    restart: unless-stopped
    environment:
      - VITE_API_URL=http://backend:8000
    ports:
      - "${DASHBOARD_PORT:-3001}:3000"
    networks:
      - callcenter-network

volumes:
  postgres_data:
  mariadb_data:
  asterisk_logs:
  asterisk_spool:
  audio_preprocess_data:
  freepbx_data:
  freepbx_backup:


networks:
  callcenter-network:
    driver: bridge
