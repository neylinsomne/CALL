services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: callcenter-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./services/backend/database/sql/local_schema.sql:/docker-entrypoint-initdb.d/01_schema.sql
      - ./services/backend/vocabulary_schema.sql:/docker-entrypoint-initdb.d/02_vocabulary.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - callcenter-network

  # ===========================================
  # Backend API + WebSocket Manager
  # ===========================================
  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    container_name: callcenter-backend
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - TTS_URL=http://tts:8001
      - STT_URL=http://stt:8002
      - LLM_URL=http://llm:8003
      - CALL_CENTER_GREETING=${CALL_CENTER_GREETING}
      # License configuration (required for on-premise deployments)
      - LICENSE_KEY=${LICENSE_KEY:-}
      - LICENSE_SERVER_URL=${LICENSE_SERVER_URL:-https://license.callcenter-ai.com}
      - LICENSE_CACHE_DIR=/var/lib/callcenter/license
      - ADMIN_API_KEY=${ADMIN_API_KEY:-change-me-in-production}
      # Supabase (Platform Database)
      - SUPABASE_DB_URL=${SUPABASE_DB_URL:-}
      - SUPABASE_DB_SSL=${SUPABASE_DB_SSL:-prefer}
    ports:
      - "${BACKEND_PORT}:8000"
    volumes:
      - ./shared/audio:/app/audio
      - backend_license_cache:/var/lib/callcenter/license
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - callcenter-network

  # ===========================================
  # License Server (Internal - Only for your company)
  # ===========================================
  license_server:
    build:
      context: ./services/license_server
      dockerfile: Dockerfile
    container_name: callcenter-license-server
    restart: unless-stopped
    environment:
      - LICENSE_DATABASE_URL=sqlite:///./licenses.db
    ports:
      - "8100:8000"
    volumes:
      - license_data:/app/data
    networks:
      - callcenter-network
    # IMPORTANTE: Este servicio NO debe desplegarse en instalaciones de clientes
    # Solo debe correr en tu infraestructura interna
    profiles:
      - internal

  # ===========================================
  # TTS Service (F5-TTS or Kokoro backend)
  # ===========================================
  tts:
    build:
      context: ./services/tts
      dockerfile: Dockerfile
    container_name: callcenter-tts
    restart: unless-stopped
    environment:
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - TTS_MODEL=${TTS_MODEL}
      - DEVICE=${TTS_DEVICE:-cpu}
      # Kokoro backend (set TTS_BACKEND=kokoro to switch)
      - TTS_BACKEND=${TTS_BACKEND:-f5}
      - KOKORO_VOICE_PATH=${KOKORO_VOICE_PATH:-}
      - KOKORO_VOICE_STYLE=${KOKORO_VOICE_STYLE:-ef_dora}
      - KOKORO_LANG=${KOKORO_LANG:-e}
    ports:
      - "${TTS_PORT}:8001"
    volumes:
      - ./shared/models:/app/models
      - ./shared/audio:/app/audio
      - distillation_data:/data/distillation
    networks:
      - callcenter-network

  # ===========================================
  # Triton Inference Server (STT Backend)
  # ===========================================
  triton:
    build:
      context: ./services/triton
      dockerfile: Dockerfile
    container_name: callcenter-triton
    restart: unless-stopped
    environment:
      - STT_MODEL=${TRITON_STT_MODEL:-small}
      - DEVICE=cuda
      - COMPUTE_TYPE=${TRITON_COMPUTE_TYPE:-float16}
      - LANGUAGE=${STT_LANGUAGE:-es}
      - MODEL_CACHE=/models/whisper
    ports:
      - "${TRITON_HTTP_PORT:-8010}:8010"
      - "${TRITON_GRPC_PORT:-8011}:8011"
      - "${TRITON_METRICS_PORT:-8012}:8012"
    volumes:
      - ./services/triton/model_repository:/model_repository
      - ./shared/models:/models/whisper
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8010/v2/health/ready" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - callcenter-network
    profiles:
      - triton

  # ===========================================
  # Whisper STT Service
  # ===========================================
  stt:
    build:
      context: ./services/stt
      dockerfile: Dockerfile
    container_name: callcenter-stt
    restart: unless-stopped
    environment:
      - STT_MODEL=${STT_MODEL}
      - DEVICE=${STT_DEVICE}
      - LANGUAGE=${STT_LANGUAGE}
      - USE_TRITON=${USE_TRITON:-false}
      - TRITON_URL=http://triton:8010
      - TRITON_MODEL_NAME=whisper_stt
    ports:
      - "${STT_PORT}:8002"
    volumes:
      - ./shared/models:/app/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    networks:
      - callcenter-network

  # ===========================================
  # LLM Service (LangChain + LM Studio)
  # ===========================================
  llm:
    build:
      context: ./services/llm
      dockerfile: Dockerfile
    container_name: callcenter-llm
    restart: unless-stopped
    environment:
      - LM_STUDIO_URL=${LM_STUDIO_URL}
      - LM_STUDIO_MODEL=${LM_STUDIO_MODEL}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "${LLM_PORT}:8003"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - callcenter-network

  # ===========================================
  # Audio Preprocessing (Noise Suppression + Speaker ID)
  # ===========================================
  audio_preprocess:
    build:
      context: ./services/audio_preprocess
      dockerfile: Dockerfile
    container_name: callcenter-audio-preprocess
    restart: unless-stopped
    environment:
      - DEVICE=${AUDIO_DEVICE:-cuda}
      - SAMPLE_RATE=16000
      - DENOISE_MODEL=deepfilternet
    ports:
      - "${AUDIO_PREPROCESS_PORT:-8004}:8004"
    volumes:
      - ./shared/models:/app/models
      - audio_preprocess_data:/app/data
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    networks:
      - callcenter-network

  # ===========================================
  # MariaDB (Para FreePBX)
  # ===========================================
  mariadb:
    image: mariadb:10.11
    container_name: callcenter-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: asterisk
      MYSQL_USER: ${MYSQL_USER:-asteriskuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-asteriskpass}
    volumes:
      - mariadb_data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - callcenter-network
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Asterisk PBX
  # ===========================================
  asterisk:
    build:
      context: ./services/asterisk
      dockerfile: Dockerfile
    container_name: callcenter-asterisk
    restart: unless-stopped
    environment:
      - ASTERISK_USER=${ASTERISK_USER}
      - ASTERISK_PASSWORD=${ASTERISK_PASSWORD}
      - ARI_PASSWORD=${ARI_PASSWORD:-ari123}
      - FREEPBX_AMI_PASSWORD=${FREEPBX_AMI_PASSWORD:-freepbx123}
      - BACKEND_AMI_PASSWORD=${BACKEND_AMI_PASSWORD:-backend123}
      - GATEWAY_FXO_IP=${GATEWAY_FXO_IP:-192.168.1.100}
      - GATEWAY_FXO_USER=${GATEWAY_FXO_USER:-gateway}
      - GATEWAY_FXO_PASSWORD=${GATEWAY_FXO_PASSWORD:-gateway123}
      # NAT / Network Configuration
      - EXTERNAL_IP=${EXTERNAL_IP:-}
      - LOCAL_NETWORK=${LOCAL_NETWORK:-192.168.1.0/24}
      - RTP_PORT_START=${RTP_PORT_START:-10000}
      - RTP_PORT_END=${RTP_PORT_END:-20000}
      # SIP Trunk
      - SIP_TRUNK_HOST=${SIP_TRUNK_HOST:-}
      - SIP_TRUNK_USER=${SIP_TRUNK_USER:-}
      - SIP_TRUNK_PASSWORD=${SIP_TRUNK_PASSWORD:-}
      # DDNS (Dynamic IP)
      - DDNS_ENABLED=${DDNS_ENABLED:-false}
      - DDNS_PROVIDER=${DDNS_PROVIDER:-duckdns}
      - DDNS_DOMAIN=${DDNS_DOMAIN:-}
      - DDNS_TOKEN=${DDNS_TOKEN:-}
      # WebRTC
      - WEBRTC_PASSWORD=${WEBRTC_PASSWORD:-webrtc123}
    ports:
      - "${ASTERISK_SIP_PORT:-5060}:5060/udp"
      - "${ASTERISK_SIP_PORT:-5060}:5060/tcp"
      - "5061:5061/tcp" # SIP TLS
      - "${ASTERISK_WS_PORT:-8088}:8088"
      - "8089:8089" # WebSocket Secure
      - "5038:5038" # AMI port
      - "${RTP_PORT_START:-10000}-${RTP_PORT_END:-20000}:${RTP_PORT_START:-10000}-${RTP_PORT_END:-20000}/udp" # RTP ports
    volumes:
      - ./services/asterisk/config:/etc/asterisk/custom
      - asterisk_logs:/var/log/asterisk
      - asterisk_spool:/var/spool/asterisk
    # Descomenta si usas tarjetas DAHDI:
    # privileged: true
    # devices:
    #   - /dev/dahdi:/dev/dahdi
    networks:
      - callcenter-network
    depends_on:
      mariadb:
        condition: service_healthy

  # ===========================================
  # FreePBX (Interfaz de Gestión)
  # ===========================================
  freepbx:
    image: tiredofit/freepbx:latest
    container_name: callcenter-freepbx
    restart: unless-stopped
    environment:
      # Base de datos
      - DB_EMBEDDED=FALSE
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_NAME=asterisk
      - DB_USER=${MYSQL_USER:-asteriskuser}
      - DB_PASS=${MYSQL_PASSWORD:-asteriskpass}

      # RTP ports
      - RTP_START=10000
      - RTP_FINISH=10100

      # UCP (User Control Panel)
      - ENABLE_UCP=TRUE

      # Asterisk config location
      - ASTERISK_CONFIG_LOCATION=custom

      # Timezone
      - TZ=America/Mexico_City

      # Admin credentials
      - ADMIN_USER=${FREEPBX_ADMIN_USER:-admin}
      - ADMIN_PASS=${FREEPBX_ADMIN_PASSWORD:-admin123}
    ports:
      - "8080:80" # FreePBX Web UI
      - "8443:443" # FreePBX HTTPS
    volumes:
      - ./services/asterisk/config:/etc/asterisk/custom
      - freepbx_data:/data
      - freepbx_backup:/var/lib/asterisk/backup
    networks:
      - callcenter-network
    depends_on:
      mariadb:
        condition: service_healthy
      asterisk:
        condition: service_started

  # ===========================================
  # Voice Distillation Pipeline (F5-TTS → Kokoro)
  # Activate with: docker compose --profile training up voice_distillation
  # ===========================================
  voice_distillation:
    build:
      context: ./services/voice_distillation
      dockerfile: Dockerfile
    container_name: callcenter-voice-distillation
    environment:
      - TTS_URL=http://tts:8001
      - AUDIO_PREPROCESS_URL=http://audio_preprocess:8004
      - DISTILLATION_OUTPUT=/data/distillation
      - DEVICE=${TTS_DEVICE:-cpu}
    volumes:
      - distillation_data:/data/distillation
      - ./shared/audio:/app/audio
      - ./shared/models:/app/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    depends_on:
      - tts
    networks:
      - callcenter-network
    profiles:
      - training

  # ===========================================
  # React Dashboard (Client-Facing)
  # ===========================================
  dashboard:
    build:
      context: ./services/dashboard
      dockerfile: Dockerfile
    container_name: callcenter-dashboard
    restart: unless-stopped
    environment:
      - VITE_API_URL=http://backend:8000
    ports:
      - "${DASHBOARD_PORT:-3001}:3000"
    networks:
      - callcenter-network

  # ===========================================
  # Admin Dashboard (Internal Only - Installers/Tech Team)
  # ===========================================
  # Activate with: docker compose --profile internal up admin-dashboard
  # This dashboard is for your team to configure deployments,
  # NOT for end clients. Never deploy this to client installations.
  admin-dashboard:
    build:
      context: ./services/admin-dashboard
      dockerfile: Dockerfile
    container_name: callcenter-admin-dashboard
    restart: unless-stopped
    environment:
      - VITE_API_URL=http://backend:8000
      - VITE_ADMIN_MODE=true
    ports:
      - "${ADMIN_DASHBOARD_PORT:-3002}:3000"
    networks:
      - callcenter-network
    profiles:
      - internal

volumes:
  postgres_data:
  mariadb_data:
  asterisk_logs:
  asterisk_spool:
  audio_preprocess_data:
  freepbx_data:
  freepbx_backup:
  license_data:
  backend_license_cache:
  distillation_data:


networks:
  callcenter-network:
    driver: bridge
