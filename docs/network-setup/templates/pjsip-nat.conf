; =============================================================================
; PJSIP Configuration Template - NAT Traversal
; =============================================================================
; Este archivo contiene la configuración de PJSIP optimizada para NAT.
; Copia este contenido a tu pjsip.conf o usa FreePBX para configurar.
;
; Variables a reemplazar:
;   ${EXTERNAL_IP}     - Tu IP pública o dominio DDNS
;   ${LOCAL_NETWORK}   - Tu red local (ej: 192.168.1.0/24)
;   ${SIP_PROVIDER_IP} - IP de tu proveedor SIP
;   ${SIP_USERNAME}    - Usuario del trunk SIP
;   ${SIP_PASSWORD}    - Password del trunk SIP
;   ${SIP_HOST}        - Host del proveedor SIP
; =============================================================================


; ===========================================
; TRANSPORT - UDP con NAT
; ===========================================
[transport-udp-nat]
type=transport
protocol=udp
bind=0.0.0.0:5060

; === CONFIGURACIÓN NAT CRÍTICA ===
; Tu IP pública (reemplazar con tu IP real o dominio DDNS)
external_media_address=${EXTERNAL_IP}
external_signaling_address=${EXTERNAL_IP}

; Redes locales (NO reescribir tráfico interno)
local_net=192.168.0.0/16
local_net=10.0.0.0/8
local_net=172.16.0.0/12
local_net=127.0.0.1/32

; Si tu red local es específica, agrégala:
; local_net=${LOCAL_NETWORK}


; ===========================================
; TRANSPORT - TCP con NAT (respaldo)
; ===========================================
[transport-tcp-nat]
type=transport
protocol=tcp
bind=0.0.0.0:5060
external_media_address=${EXTERNAL_IP}
external_signaling_address=${EXTERNAL_IP}
local_net=192.168.0.0/16
local_net=10.0.0.0/8
local_net=172.16.0.0/12


; ===========================================
; TRANSPORT - TLS (Seguro)
; ===========================================
[transport-tls-nat]
type=transport
protocol=tls
bind=0.0.0.0:5061
external_media_address=${EXTERNAL_IP}
external_signaling_address=${EXTERNAL_IP}
local_net=192.168.0.0/16
local_net=10.0.0.0/8
; Certificados TLS
cert_file=/etc/asterisk/keys/asterisk.pem
priv_key_file=/etc/asterisk/keys/asterisk.key
ca_list_file=/etc/asterisk/keys/ca.crt
method=tlsv1_2


; ===========================================
; TRUNK - Registro con Proveedor SIP
; ===========================================
[trunk-provider-registration]
type=registration
transport=transport-udp-nat
outbound_auth=trunk-provider-auth
server_uri=sip:${SIP_HOST}
client_uri=sip:${SIP_USERNAME}@${SIP_HOST}
retry_interval=60
expiration=3600
; Opciones NAT
line=yes
endpoint=trunk-provider


; ===========================================
; TRUNK - Autenticación
; ===========================================
[trunk-provider-auth]
type=auth
auth_type=userpass
username=${SIP_USERNAME}
password=${SIP_PASSWORD}


; ===========================================
; TRUNK - Endpoint Principal
; ===========================================
[trunk-provider]
type=endpoint
transport=transport-udp-nat
context=from-trunk

; Codecs (en orden de preferencia)
disallow=all
allow=opus
allow=g722
allow=ulaw
allow=alaw

; Autenticación
outbound_auth=trunk-provider-auth
aors=trunk-provider-aor

; === OPCIONES NAT CRÍTICAS ===
direct_media=no              ; Forzar media a través de Asterisk
force_rport=yes              ; Usar puerto de respuesta real
rewrite_contact=yes          ; Reescribir header Contact
rtp_symmetric=yes            ; RTP simétrico (misma IP/puerto)
ice_support=no               ; Deshabilitar ICE (causa problemas con NAT simple)

; Otras opciones útiles
trust_id_inbound=yes
send_pai=yes
send_rpid=yes
callerid="Call Center AI" <${SIP_USERNAME}>

; Manejo de sesiones
timers=yes
timers_min_se=90
timers_sess_expires=1800

; DTMF
dtmf_mode=rfc4733


; ===========================================
; TRUNK - AOR (Address of Record)
; ===========================================
[trunk-provider-aor]
type=aor
contact=sip:${SIP_HOST}
qualify_frequency=60
qualify_timeout=5.0


; ===========================================
; TRUNK - Identificación por IP
; ===========================================
[trunk-provider-identify]
type=identify
endpoint=trunk-provider
match=${SIP_PROVIDER_IP}


; ===========================================
; ENDPOINT INTERNO - Para softphones/WebRTC
; ===========================================
[internal-template](!)
type=endpoint
transport=transport-udp-nat
context=from-internal
disallow=all
allow=opus
allow=ulaw
allow=alaw

; NAT para clientes internos que pueden estar detrás de NAT también
direct_media=no
force_rport=yes
rewrite_contact=yes
rtp_symmetric=yes


; Ejemplo de extensión interna
[1001](internal-template)
auth=1001-auth
aors=1001-aor
callerid="Agente 1" <1001>

[1001-auth]
type=auth
auth_type=userpass
username=1001
password=secreto123

[1001-aor]
type=aor
max_contacts=3
remove_existing=yes
qualify_frequency=30


; ===========================================
; NOTAS DE CONFIGURACIÓN
; ===========================================
;
; 1. EXTERNAL_IP:
;    - Si tienes IP fija: Pon la IP directamente (ej: 181.123.456.789)
;    - Si tienes IP dinámica: Usa un dominio DDNS (ej: micallcenter.ddns.net)
;
; 2. LOCAL_NET:
;    - Incluye TODAS las redes locales que uses
;    - Formato CIDR: 192.168.1.0/24, 10.0.0.0/8, etc.
;
; 3. DIRECT_MEDIA=NO:
;    - SIEMPRE dejarlo en NO cuando hay NAT
;    - Esto fuerza el audio a pasar por Asterisk
;
; 4. RTP_SYMMETRIC=YES:
;    - Crítico para NAT
;    - Usa el mismo puerto para enviar y recibir
;
; 5. Para debug de NAT:
;    asterisk -rx "pjsip set logger on"
;    asterisk -rx "rtp set debug on"
;
